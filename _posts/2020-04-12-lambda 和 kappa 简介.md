---
layout:		post
title:  	Lambda 和 Kappa 架构简介
subtitle:   
date:       2020-04-12
author:     一轩明月
header-img: img/post-bg-universe.jpg
catalog:    true
tags:
    - Big Data
excerpt:    本文主要介绍各两个实时数据处理架构——Lambda 和 Kappa。展示它们是如何解决实时数据处理中的容灾和弹性问题的，又是怎样保证在支持离线和增量更新的同时还具备可扩展性的，以及什么情况下用其中一个比另一个好。
---

> 编译自：A brief introduction to two data processing architectures — Lambda and Kappa for Big Data，[Iman Samizadeh](https://towardsdatascience.com/@iman.samizadeh?source=post_page-----4f35c28005bb----------------------)

大数据，物联网（IoT），机器学习和各式各样的现代系统对人们来说早已司空见惯。各行各业的人都开始和数据存储与数据服务打交道。可以说，无论是个人，科研组织还是商业公司，都在密切关注怎样处理大数据才是最佳方式。可以想到，对于期望实现特定商业目标的应用来说，如果能高效处理顾客请求使他们的需求得到满足，必然可以带来更大的商业价值。而这类应用不可避免的要和数据存储设施进行交互，本文就会介绍各类企业应用背后的基石，两个重要的数据处理架构——Lambda 和 Kappa。

![](https://raw.githubusercontent.com/LibertyDream/diy_img_host/master/img/2020-04-10_lambda_kappa.png)

同时，随着社交媒体应用，云系统和物联网的兴起以及各类创新接连不断的涌现，开发人员或数据科学家在启用、更新或修复应用的时候必须审慎、周密地进行决策。尽管使用分治思想，模块化开发应用的路数早已是尽人皆知，大家都明白这样做的诸多好处以及相伴的长期利好，可是如何选择“正确”的数据处理架构依然是许多现有或未面世企业软件的必答题。虽然市面上已经有很多数据处理架构了，我们还是来重点看一下 Lambda 和 Kappa 这两兄弟，看看他们是怎么解决实时数据处理中的容灾和弹性问题的，又是怎样在支持离线和增量更新的同时保证可扩展性的，以及什么情况下用其中一个比另一个好。

### Lambda 架构

Lambda 架构是一种能高效处理海量数据的实时数据处理技术，其高效性来自于大吞吐量，低延迟以及良好的容错性。而一般讲到“数据处理”，多是指代高吞吐，低延迟和准实时计算导向的一类应用，它们允许开发人员以代码逻辑形式或是基于事件的自然语言处理模型来定义增量规则，从而实现鲁棒、高效与自动化，由此改善数据质量。同时，任何数据状态的变动对这些系统来讲都是一个事件，事实上，系统可能会下达一项命令在后台查询或调用增量程序来响应事件。

事件溯源是指使用事件进行预测同时实时存储系统变化，一次数据库更新或是某一事件的发生都可以理解为“变化”。比如，某人浏览 web 页面或是社交网络简介时，页面视图、喜欢或好友申请请求等事件可能会被触发并得到处理或完善，相应数据被存入数据库。

数据处理就是要不断解决事件流，而绝大多数企业软件都遵循领域驱动设计（Domain Driven Design）原则，采用流处理方法预测基础模型更新内容，同时将作为“预测燃料”的不同事件存入在线数据系统。为了解决系统面对的海量事件以及增量处理任务，Lambda 架构将数据处理流程整体分成了三层——离线层（Batch Layer），加速层（Speed layer），服务层（Serving layer）。

![](https://raw.githubusercontent.com/LibertyDream/diy_img_host/master/img/2020-04-10_lambda_batch.jpg)

- 离线层

新数据不断喂给数据系统，期间每个样本都会同时发给离线和加速层。所有进入离线层的数据流都会在数据湖（Data Lake）上进行计算处理。数据湖多会使用基于内存的数据库或 NoSQL 类的永久存储设施，数据存好后离线层使用 MapReduce 或一些机器学习方法对数据进行处理并由此对接下来的内容进行预测。

- 加速层

加速层会享用离线层事件溯源成果。离线层中的数据处理会涉及增量程序，MapReduce 或机器学习模型的更新，模型会被加速层进一步用来处理新数据。就这样，加速层借助富集过程得到结果，保证服务层请求响应延迟处于低位。而加速层也几乎只处理实时数据，计算负荷较低，延迟有保障。

- 服务层

从离线层得到离线视图（batch view），加速层得到准实时视图（near-real time view），统一送给服务层。服务层使用这些信息临时应付那些等候的查询。

如果将整个过程用函数方程表示，任意大数据查询都可归结为如下形式



$$
\text{Query} = \lambda(\text{Complete data})=\lambda(\text{live streaming data})\cdot \lambda(\text{stored data})
$$



方程中所用符号名为 Lambda_（音译：拉姆达）_，Lambda 架构的名字也源自于此。这个方程广为熟悉数据分析轶事的人所知，从中可以看出所有数据相关查询，结合离线历史信息和实时流，Lambda 架构都能处理。

#### Lambda 架构应用

Lambda 架构适用于这样一些企业应用：

- 用户查询要临时用到永久存储内容
- 快速响应，能应付各种形式的数据流更新
- 不删除记录，支持添加、更新数据

Lambda 架构是准实时处理框架，既能抵御故障又具备可拓展性，在离线层和加速层加持下，不断将新数据存入主存储设备中并保证既有数据的完整性。像 Twitter，Netflix 和 Yahoo 这样的大公司都在使用该架构保证服务达标。

#### Lambda 架构优缺点

优点：

- 离线层采用分布式存储管理历史信息，即使系统崩溃也不太可能损伤到数据
- 有效平衡了速度与可靠性
- 容灾而兼具弹性的数据处理架构

缺点：

- 全场景覆盖带来的编码开销
- 针对具体场景重新离线训练一遍益处不大
- 重新部署和迁移成本很高

### Kappa 架构

2014 年 Jay Kreps 在一次研讨会上指出了一些 Lambda 架构间的差异，大数据世界自此迎来了另一个备选架构，它的代码量更少，特别适用于那些使用多层 Lambda 架构显得有些奢侈的企业场景。

Kappa 架构不能被简单视作 Lambda 架构的替代品，相反，它是在离线层对满足业务需求不是必须项时的一个备选项。该架构适合实时处理不同事件，下图展示了其整体结构

![](https://raw.githubusercontent.com/LibertyDream/diy_img_host/master/img/2020-04-14_kappa.jpg)

同样，将 Kappa 架构的整体流程转换成功能方程，任意数据查询形式归结为



$$
\text{Query} = K(\text{New data})=K(\text{Live streaming data})
$$



从方程可以看出所有查询都能通过加速层对实时数据流的处理得到满足。同时也指出流处理过程发生在 Kappa 架构的加速层中

#### Kappa 架构应用

各式各样的网络应用，基于云监控系统的设备和物联网都是在用优化版的 Lambda 架构，借助加速层和服务层来对数据湖上的数据进行处理

Kappa 架构适合这样一些企业模型：

- 诸多数据事件或查询登记到队列中等待分布式文件系统处理
- 事件或查询顺序并没有被预先决定好。流处理平台可以选择在任意时间与数据库交互
- 弹性和高可用地处理 TB 级数据，要求系统中的每个结点都支持备份

上面这些数据场景 Apache  Kafka 都能应对，其快速、容灾且水平可拓展，提供了一种更好的数据流管控机制。对流处理器和数据库的均衡控制保证应用能达到期望中的水平。Kafka 对订阅数据保有时间更长，对相似的查询则会链接到留存日志的相关位置。LinkedIn 和其他一些应用都在使用 Kafka 进行大数据处理，通过保留海量数据来应对彼此差异不大的相似查询

#### Kappa 架构优缺点

优点：

- 无需离线层
- 只有当代码变更时才需要重新处理
- 可以使用固定内存进行部署
- 可用于具备水平扩展性的系统
- 机器学习是实时的，所以所需资源更少

缺点：

- 缺少离线层可能导致数据处理或数据库更新时发生错误，所以往往需要异常管理器来调解矛盾，恢复数据

### 总结

Lambda 和 Kappa 架构间的选择是一种取舍权衡。如果你想要更可靠的架构，更新数据湖时还能鲁棒地训练机器学习模型来预测未来事件，那你该选择 Lambda 架构，离线层和加速层的搭配保证错误更少，速度不慢。另一方面，如果你想节省大数据架构上的硬件开销，高效处理实时出现的各种独特事件，亦或历史数据和实时数据的处理方式一致，那 Kappa 架构更合适。

两个架构都能通过开源技术的组合进行实现。比如数据可以通过发布-订阅式消息系统，如 Kafka，注入架构中。数据和模型的存储则可以使用 HDFS 这样的持久化存储设施。高延迟类的批处理系统，比如 Hadoop MapReduce 可以用在 Lambda 架构的离线层去训练模型。低延迟系统，比如 Apache Storm，Apache Samza 和 Spark Streaming 则可以用来在加速层更新模型。实现 Kappa 架构完全可以采用相同的技术。

此外，如果选用 Apache Spark 作为通用平台来开发加速层和离线层的话，两层之间可以共享很多代码。服务层可以使用 Apache HBase 这样的  NoSQL 数据库，或 Apache Drill 类的 SQL 查询引擎