---
layout: post
title: 用 Jupyter Notebook 复现研究的十条简单规则
date: 2019-08-03
author: 一轩明月
header-img: img/post-bg-hacker.jpg
catalog: true
tags:
    - Jupyter Notebook
    - Research
excerpt:    Jupyter Notebooks 降低了复现研究时的门槛，但是也有一些其独有的问题。比如很少一部分开源笔记能直接顺利运行，多数都有数据访问不到、依赖没解决或是平台差异的问题。本文提供了一系列规则、技巧、工具和样例 notebook 作参考，给出了在 notebook 开发流程各阶段需要注意的规则。
---

> 文章编译自：
>
> https://arxiv.org/abs/1810.08055

### 摘要

计算研究领域的可复现性是科学方法论的一个重要标志。可复现保证了研究员可以信任别人的方法或发现，能够复用和拓展计算流水线并以此带动科学进步。鉴于许多实验研究都依托于计算分析，教研究员们如何构建和记录可复现的数据分析与模拟流程是必要的。

本文着重探讨了几个复现性的问题。比如，可复现研究面临的技术和非技术困境，计算型笔记对这些难题带来哪些机遇又有哪些问题，能用到哪些工具，怎么高效使用这些工具，等等。

以 Jupyter Notebook 为代表的计算型笔记近来在许多任务上得到了应用，我们为此对使用计算型笔记的科学家们拟定了系列规则。计算型笔记将工作流、叙述文本和可视化结果相结合，还整合了软件库与开源协议，是公开化、易协作、可复现和重用的数据分析工作的利器。

### 引言

随着计算研究的规模、复杂度和依赖程度增高，想要得到复现研究需要的详细、精确的描述文档愈发困难。

复现性需要对人和机器都可读的描述信息，比如构建研究任务的数据、软件、依赖、计算环境（硬件或云配置）以及如何将他们拼凑在一起。以往这些部件都是分离的，当人们开始使用类似 Jupyter Notebooks 和 R Notebooks 的计算型笔记时，可执行代码、可视化结果以及文字描述都在一个交互式文档内得到了整合。

Jupyter Notebooks 确实降低了复现研究时的门槛，但是也因为它的交互性，带了一些其独有的问题。比如很少一部分开源笔记能直接顺利运行，多数都有数据访问不到、依赖没解决或是平台差异的问题。

除去上述技术问题，一些研究笔记中的文字描述通常是对分析步骤抽象、是高层次的描述而不是解释为什么做，为什么是这个结果。还有些人如果觉得文档混乱或有些私人就不将其公开。科学家们能利用 notebook 的交互性构建分析环境，但很难将其变成别人也能阅读、运行的描述清晰的研究文档。

考虑到这些困境，我们构建了一系列规则、技巧、工具和样例 notebook 给那些 Jupyter Notebook 作者们作参考。下面这张图里，我们简明给出了在 notebook 开发流程各阶段需要注意的规则。

![]( https://raw.githubusercontent.com/LibertyDream/diy_img_host/master/img/2019-08-03_simplified_notebook_cycyle.png)

从上至下我们介绍了如果要保证书写规范、功能良好，一个复现研究的 Jupyter Notebook 应该走过的三个阶段。一阶段组织、编写 notebook （规则1-3）。二阶段按照给出的代码质量控制建议编写代码（规则4-7）。最后强调了 notebook 和相关数据应该都可访问（规则8），请积极探索和贡献（规则9—10）。

### 规则一：给观众讲个故事

使用 Jupyter Notebook 的一个关键好处在于你可以穿梭于解释性文本、代码和执行结果间，讲述一个计算的故事。相比于零星的注释，你应该用解释性文本讲述一个完整的故事，开头介绍一下这个话题，中间描述你的步骤，最后解释一下结果。你不仅应该告诉人们你做了什么，还要说明为什么，步骤间怎么衔接的以及它们的意义。

讲述故事的具体风格依你的观众而定。你计划将你的 notebook 分享给实验室的非技术同事，还是其他实验室的分析师，专业期刊上的读者，亦或是普通大众？对这些观众你可能需要不同种类、不同水准的解释。无论如何，请记住你未来主要的读者很可能是你自己。你的文稿是否足够清晰，能保证一个月后再看你依然能理解并重复分析流程？人们总是高估他们将来能记住多少，在解释力度上浮皮潦草。如果你在不远的将来都无法复现结果，又有谁能做到呢？

### 规则二：记录过程，而不只是结果

计算笔记的交互式特性使得尝试比对不同方法、参数十分便捷、快速——方便到我们经常来不及在比对时记录下这些交互结果。由此，纸质时代记录实验科学笔记的那些建议更加重要：记录你所有的探索过程，甚至（可能是关键）是那些失败的结果！这些内容能帮你记住你做了什么，为什么这么做。你随时可以在后续将笔记转为流水线（规则七）时删掉它们，或是拿来和不同的听众分享（规则一）。

许多 notebook 使用者习惯于等到分析结束，得到可接受结果之后才添加解释文字。别等，那时你可能已经忘了为什么选一个特定参数（可能从哪里copy来的），或是你偶然发现的一个有趣结果。如果你当时不能完整记录你的工作和想法，留下简短注释提醒自己阶段工作完成后回头要添加什么内容。复现研究的代码会被自动记录，推理和直觉不会。即便你的故事随着时间推移会变动，那也无妨。从一开始你就该讲故事，即使你还不知道结局。

每次做完实验或有意义的工作后（要跟踪变更防止错误——见规则六），请整理、组织和注解你的 notebook。当你准备发布时，尽量不要使用桌面发布工具手动调节图像，用 notebook 的绘图库制作发布版图像和其他手稿用图像。确保留有你的名字和联系方式，以便别人能联系到你的实验室询问代码上的基本问题。记下分析工作的起止日期是个不错的想法，也可以强调你在开发 notebook 期间所做的努力。

### 规则三：添加分区使步骤清晰

Notebooks 是交互式环境，能很容易写出和运行一行内容的单元格。这一点对实验有益但可能会让你的笔记混乱，全是割裂的小片段。可以尝试每个单元格只负责一个有意义的分析功能，人们能从单元格内的代码或是旁边的 markdown 文本轻易地理解内容。

通过单元格和在单元格上方添加 markdown 标记模块化你的代码。每个单元格视为一个段落，包含一个函数或是完成一项任务（比如绘图）。避免长文单元格（我们认为超过100行或是一页的都太长了）。

把低级叙述文字放在代码注释里。为了便于导航，你应该用描述性 markdown 标题将你的 notebook 组织成不同部分并添加一个目录。将长 notebook 分成若干笔记，其中顶级索引 notebook 要能链接到各个笔记。

### 规则四：模块化代码

避免重复代码总是好的，但在 notebook 里复制单元格，调整几行，粘贴结果代码到新一个格或其他笔记中都极其容易。这些对实验来说是好处，但会让笔记难以阅读，修改复制代码的功能或修复其中的 bug 近乎于不可能。实际上，你应该封装你打算复制和重用的代码到一个函数里，这样在随意一个单元格里都可以调用了。如果你想在其他项目或是笔记里使用，可以考虑打包成模块、包或是库——还要遵循软件开发实践经验，比如单元测试。

模块化不仅省空间、易维护、方便调试，也能更便捷的增强交互性。比如你可以把小部件([ipywidgets](https://ipywidgets.readthedocs.io/en/stable/))添加到函数里来支持对不同参数值的研究，或是支持可视化交互而不用修改代码。

### 规则五：记录依赖

复现你的研究成果不仅要你的代码，还有所有依赖项。计算科学领域最佳实践是列出所有依赖项（包括它们的软件版本），而要清楚明白地管理依赖项，从使用类似 Conda 的 environment.yml 或是 pip 的 requirement.txt 开始。只在这些依赖项上搭建项目能确保你不会忘记记录某个依赖项。

在 notebook 里，借助 [watermark](https://github.com/rasbt/watermark) 之类的笔记扩展你可以清楚的打印出你的依赖项。如果脱离笔记环境，在笔记里（最好是底部）列出关键依赖项的版本能保证关键信息不丢失，读者依旧能凭此复现结果。

### 规则六：使用版本控制

版本控制对于 notebook 的使用来讲很重要，因为 notebook 的交互特性很可能会偶尔变更或删除某些重要内容。此外，笔记里有代码，代码不可避免的有 bug，那么确认在何时某个 bug 添加到了代码里又是在何时修复的，并由此哪些分析环节可能受影响，无疑是科学计算的关键能力。

可以在[这里](https://github.com/LibertyDream/git_github_gitlab_tutorial)学习利用 Git 和 GitHub 进行常规的版本控制，也可以在[这里](http://drivendata.github.io/cookiecutter-data-science/)学习如何将你的库组织成易于版本控制的样子。

但是注意到 Jupyter Notebook 会同时将代码和每个单元格特定的元数据存储到一个 JSON（JavaScript Object Notation） 格式的文档中。版本控制系统会比较这些 JSON 文件的差异，而不是用户友好的 notebook 图形交互界面（GUI, graphical user interface)。鉴于此，用户很难找到和理解给定笔记的不同版本的差异，因为这些都被转换成了 JSON 元数据信息。一个办法是使用专业的笔记比对工具，比如 [nbdime](https://github.com/jupyter/nbdime),它能理解笔记结构并友好的将差异展示出来。另一种方法是使用 [post-save hook](https://www.svds.com/jupyter-notebook-best-practices-for-data-science/) 将笔记本文件转换成更易于理解的版本控制格式。比如，你可能有两个文件夹，一个是原生笔记，另一个是转换后剔除输出结果的 .py 文件。但要记得两个都要进行版本控制，即使你只凭剔除结果后的版本也能看出版本变化。

### 规则七：构建流水线

初始的探索性调研笔记本很少被泛化与推广，但一旦某个分析套路被认定可行，设计良好的 notebook 可以被泛化成一条流水线（pipeline），很方便的使用不同输入数据和参数重复实验。考虑到这点，你在设计 notebook 的时候就该考虑到未来可能的功用改变。把关键变量的声明，特别是在另起一套分析流程时会变更的，放在 notebook 顶端而不是藏在文中某个位置。数据清洗类的准备工作也要在 notebook 里完成，同时尽量避免手动干预。

因为 notebook 的交互性使得用户很容易无意间覆盖或删掉了某些关键步骤，如果你的分析任务构建的很快，请养成定期重启内核和重新运行所有单元格的习惯，确保你没有在清理笔记的时候误删某个步骤（如果真误删了，可以借助版本控制工具恢复）。为了可以只运行复杂分析任务的某个部分，把长笔记本拆成几个只负责一个或多个关键步骤的小笔记本。还要确保每个笔记本有将关键的中间结果存储到硬盘上，好让后续笔记本使用。

对于发布了的 notebook，可以借助 [papermill](https://github.com/nteract/papermill) 类的工具将其参数化。这些笔记本不仅可以交互式使用，更可以作为可以自动化执行的命令行工具，这无疑是构建流水线的巨大利好。考虑一下使用 Makefile 或是其他类似工具衔接流水线中的各个步骤，这些工具能非交互式的运行整条流水线或是只运行某些步骤。这种自动化还支持软件测试之类的代码质量控制功能，考虑下把你的库集成到持续集成系统（比如 [Travis CI](https://travis-ci.org/)），每次变更都做一下端到端的流程测试。最后，相较于一开始分析时赋予的功用，流水线笔记本几乎都会有另一个版本的故事（规则一）。记住删除那些不通用的介绍、解释或是结论，替换成对流水线使用者的指南，引导他们怎么运行和解释结果（这是潜在的故事）。

### 规则八：分享并解释数据

如果数据访问不到，手头的笔记本注解的再清晰都对复现工作无益。努力保证数据/样本和笔记本都能被访问。Notebooks 里解释输入数据和上游处理所做的工作并不难，而这在解释结果时很重要。

理想条件下，所用到的所有数据和笔记本都是一同开放的。但我们会发现有些数据集太大或太敏感而不能开放出来。这种情况下，考虑把大而复杂的数据集分层，这样即使它依旧大到无法和笔记本一同分享，或是被政策法规限制，依然不会妨碍到可复现性。你可以在任意托管服务上开放中等规模的匿名数据备份，（比如 [figshare](https://figshare.com/), [zenodo](https://zenodo.org/))，并在最终库里提供进一步的数据集和笔记本。另一个复现研究的考量点是能永久且唯一的识别数据集，托管服务商为此提供了数字对象标识服务（doi, Digital Object IDentifiers）。分层后既能让公众放心，也能让其他人在不使用完整原始数据情况下，依旧可以重现和重用后续步骤。

### 规则九：确保你的 notebook 可读、可运行和可研究

如果你遵循了前面的规则，你的笔记本应该已经记录了你的所有过程并且易于阅读。但是要怎么让别人访问、运行和研究它们呢？有一些方法能让别人重用你的笔记本。首先，将笔记本存于公共代码库内，附上清晰的 README 文档，选择自由的开源协议准许别人重用你的代码。

允许重用外，考虑一下如何利用笔记本的特性来支持阅读与研究。至少应该在开源库里留有 HTML/PDF 格式的所有最终版的 notebook。如果20年后运行笔记的技术工具都淘汰了，这起码还留有可读的档案记录，依赖项列表，未来的读者很可能能够据此重建计算环境。你也可以使用 [NBviewer](https://nbviewer.jupyter.org/) 来提供笔记本的静态视图，省去转换成 HTML/PDF 的工作。GitHub 使用此服务来呈现其网站上的笔记本，所以上传笔记到 GitHub 也是另一种提供静态视图的优良方法。

为了他人能运行你的笔记，考虑下加上规则四里提到的小组件（ipywidgets），这样别人可以研究数据、尝试新参数而不用写代码。你可以使用 [Binder](https://mybinder.org/) 提供免安装的云笔记执行环境，这样那些觉得安装 Jupyter Notebook 或者 Jupyter Lab 困难的人也能流畅使用了。你可以创建一个运行环境的 [Docker image](https://docs.docker.com/) 轻松完成这些设置。

### 规则十：为可复现的开源研究尽一份力

显然，只是使用计算型笔记并不能保证可复现性。如果这一技术的便利和交互性已经打动了你，那请向前一步，成为你实验室或是公司里的复现性倡导者。让你的实验室同僚或是公司同事试着跑一跑你的笔记本，在他们解释哪里出错的时候倾听。也试着跑一跑他们的笔记本，如果遇到障碍告诉他们。要意识到可复现性是所有研究组计算工作的核心，而不是分析完成后的某个环节或是在期刊或审稿人要求下才做的补救性工作。

可复现的研究建立在许多开源基础环境上，比如 Jupyter Notebook，许多 Python 科学计算库和 R 的 tidyverse 库。这些都是免费的只因贡献者（通常是志愿的）和维护者不计回报的在项目上倾注时间。为了支持可复现性研究请参与到某个开源项目中去，或是为你的研究领域的复现性自己做一个软件。遵循本文的建议分享、发表你的成果。

### 样例笔记本

为了演示这十个原则，我们创建了一个 [Git 仓库](https://github.com/jupyter-guide/ten-rules-jupyter)并注解了样例笔记本。你可以按照规则八阅读、运行和研究这些笔记本。